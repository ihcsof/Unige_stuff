SET search_path TO 'socialmarket';
SET datestyle to 'MDY';

-- DROP SCHEMA socialmarket CASCADE;
CREATE SCHEMA IF NOT EXISTS socialmarket;

CREATE TABLE ENTI(
	codE INT PRIMARY KEY,
	nome VARCHAR(20) NOT NULL,
	seAutorizzatore BOOL NOT NULL
);
	
CREATE TABLE CLIENTI(
	idCliente SERIAL PRIMARY KEY, 
	dataApprovazione DATE CHECK(dataN <= CURRENT_DATE) , 
	saldo INT NOT NULL,
	ptiNonSpesi INT NOT NULL,
	cfC CHAR(16) UNIQUE NOT NULL,
	CognomeC VARCHAR(20) NOT NULL,
	NomeC VARCHAR(20) NOT NULL,
	dataN DATE NOT NULL CHECK(dataN <= CURRENT_DATE),
	telC VARCHAR(13) UNIQUE NOT NULL,
	PuntiMensili NUMERIC(2) NOT NULL DEFAULT 0,
	nBimbi INT NOT NULL DEFAULT 0,
	nAdulti INT NOT NULL DEFAULT 0,
	nAnziani INT NOT NULL DEFAULT 0,
	codE INT REFERENCES ENTI(codE),

	CHECK(dataApprovazione IS NULL OR codE IS NOT NULL),
	CHECK(PuntiMensili >= 30 AND PuntiMensili <= 60)
);

CREATE TABLE DONATORI(
	telD VARCHAR(13) PRIMARY KEY,
	mail varchar(50) UNIQUE NOT NULL,
	indirizzo varchar(50) NOT NULL,
	sePrivato BOOL
);

CREATE TABLE FAMIGLIARI(
	cfF CHAR(16) PRIMARY KEY,
	usaPunti BOOL NOT NULL,
	dataN DATE NOT NULL CHECK(dataN <= CURRENT_DATE),
	CognomeF varchar(20) NOT NULL,
	NomeF varchar(20) NOT NULL,
	TelF VARCHAR(13) UNIQUE NOT NULL,
	idCliente INT REFERENCES CLIENTI(idCliente) NOT NULL
);

CREATE TABLE VOLONTARI(
	cfV CHAR(16) PRIMARY KEY,
	dataN DATE NOT NULL CHECK(dataN <= CURRENT_DATE),
	cognomeV VARCHAR(20) NOT NULL,
	nomeV VARCHAR(20) NOT NULL,
	TelV VARCHAR(13) UNIQUE NOT NULL,
	veicolo VARCHAR(20),
	seTrasporta BOOL NOT NULL,
	seAccoglie BOOL NOT NULL,
	seScarica BOOL NOT NULL,

	CHECK((veicolo IS NULL AND seTrasporta = 'false') OR (veicolo IS NOT NULL AND seTrasporta = 'true'))
);

CREATE TABLE TURNI(
	idTurno SERIAL PRIMARY KEY,
	dataTurno DATE NOT NULL CHECK(dataTurno >= CURRENT_DATE),
	orarioInizio TIME NOT NULL,
	orarioFine TIME NOT NULL,
	cfV CHAR(16) REFERENCES VOLONTARI(cfV) NOT NULL,
	CHECK(OrarioFine > OrarioInizio),
	UNIQUE(cfV, dataTurno, orarioInizio),
	UNIQUE(cfV, dataTurno, orarioFine)
);
	
CREATE TABLE TRASPORTI(
	idT SERIAL PRIMARY KEY,
	sede VARCHAR(20) NOT NULL,
	dataT DATE NOT NULL,
	oraT TIME NOT NULL,
	numScatoloni NUMERIC(5) NOT NULL,
	cfV CHAR(16) REFERENCES VOLONTARI(cfV) NOT NULL,
	UNIQUE(dataT, oraT, cfV)
);

CREATE TABLE APPUNTAMENTI(
	idA SERIAL PRIMARY KEY, 
	saldoPrec NUMERIC(2),
	saldoSucc NUMERIC(2),
	dataA DATE NOT NULL CHECK(dataA >= CURRENT_DATE),
	ora TIME NOT NULL,
	idCliente INT REFERENCES CLIENTI(idCliente) NOT NULL,
	cfF VARCHAR(16) REFERENCES FAMIGLIARI(cfF),
	cfV VARCHAR(16) REFERENCES VOLONTARI(cfV) NOT NULL,
	UNIQUE(dataA, ora),
	CHECK(saldoPrec IS NOT NULL OR saldoSucc IS NULL), 
	CHECK(saldoPrec >= 0 AND saldoPrec <= 60),
	CHECK(saldoSucc >= 0 AND saldoSucc <= 60)
);

CREATE TABLE INVENTARIO(
	idProdotto SERIAL PRIMARY KEY,
	nomeProdotto VARCHAR(20) NOT NULL,
	tipologiaProdotto VARCHAR(20) NOT NULL,
	tolleranzaScadenza VARCHAR(20),
	quantitaInv INT NOT NULL DEFAULT 0,
	costoPunti INT NOT NULL,
	qtScaricato INT NOT NULL DEFAULT 0

	CHECK(quantitaInv >= 0)
);


CREATE TABLE DONAZIONI(
	idD SERIAL PRIMARY KEY,
	importo NUMERIC(7,2),
	dataD DATE NOT NULL,
	telD VARCHAR(13) REFERENCES DONATORI(telD) NOT NULL
);

CREATE TABLE MERCI(
	idLotto SERIAL PRIMARY KEY, 
	importoSpeso NUMERIC(7,2),
	quantita INT NOT NULL,
	dataArrivo DATE NOT NULL,
	oraArrivo TIME NOT NULL,
	scadenza DATE,
	cfV CHAR(16) REFERENCES VOLONTARI(cfV) NOT NULL,
	idD INT REFERENCES DONAZIONI(idD),
	idT INT REFERENCES TRASPORTI(idT),
	prod INT REFERENCES INVENTARIO(idProdotto) NOT NULL,

	CHECK((idD IS NULL AND importoSpeso IS NOT NULL) OR (idD IS NOT NULL AND importoSpeso IS NULL))
);

CREATE TABLE ACQUISTI(
	idA INT REFERENCES APPUNTAMENTI(idA),
	idLotto INT REFERENCES MERCI(idLotto),
	quantitaRif INT NOT NULL,
	PRIMARY KEY(idA, idLotto),
	CHECK(quantitaRif > 0)
);

CREATE TABLE APPARTENENZE(
	codE INT REFERENCES ENTI(codE),
	cfV CHAR(16) REFERENCES VOLONTARI(cfV),
	PRIMARY KEY(codE, cfV)
);

-------------------------------------------------------------------------------

INSERT INTO ENTI VALUES ('00001','SpazioFamiglia','TRUE');
INSERT INTO ENTI VALUES ('00002','CooperativaSociale','TRUE');
INSERT INTO ENTI VALUES ('00003','ScoutGE','FALSE');
INSERT INTO ENTI VALUES ('00004','ScoutSV','FALSE');
INSERT INTO ENTI VALUES ('00005','CEIS','TRUE');

-- Si inseriscono dei "numeri di componenti" più alti di quelli poi presenti per un testing migliore
INSERT INTO CLIENTI VALUES (1, '05-22-2020','40','78','ABCDEFG891234567','Chiola','Giovanni','05-21-2000','3211886543','33','1','2','3','00001');
INSERT INTO CLIENTI VALUES (2, '05-21-2021','35','90','GBCDEFG891234568','Guerrini','Giovanna','08-22-2000','3451586543','42','1','1','2','00002');
INSERT INTO CLIENTI VALUES (3, '02-01-2022','50','101','ZBCDEFG891234569','Catania','Barbara','01-23-2000','3331876543','37','2','1','4','00005');
INSERT INTO CLIENTI VALUES (4, '10-18-2019','27','35','FACAEFH283557555','Foschi','Lorenzo','03-04-2001','3384764747','38','0','0','1','00005');
INSERT INTO CLIENTI VALUES (5, '10-18-2019','26','76','GABAEJH223557543','Roncallo','Filippo','10-11-2001','3284554720','38','1','15','10','00001');
INSERT INTO CLIENTI VALUES (6, '10-18-2019','40','99','SIUAEFH243750111','Polizzi','Lucrezia','12-25-2001','3194464646','38','2','5','0','00005');

INSERT INTO DONATORI VALUES ('3456664510','donatore1@gmail.com','addr1', 'true');
INSERT INTO DONATORI VALUES ('3426464513','donatore2@alice.it','addr2', 'false');
INSERT INTO DONATORI VALUES ('3358664511','donatore4@hotmail.com','addr3', 'true');
INSERT INTO DONATORI VALUES ('3184764748','donatore5@hotmail.com','addr4', 'true');

INSERT INTO FAMIGLIARI VALUES ('DDDEEE1234567890','TRUE','10-01-2019','Elkann','Lapo','3457764510','1');
INSERT INTO FAMIGLIARI VALUES ('GGGEGI1234567890','TRUE','11-18-2019','Kart','Mario','3957764520','1');
INSERT INTO FAMIGLIARI VALUES ('AAAEEE1234567890','TRUE','10-01-2019','Briatore','Flavio','3255764520','1');
INSERT INTO FAMIGLIARI VALUES ('BBBEGI1234567892','TRUE','11-18-2019','David','Damiano','3357764518','3');
INSERT INTO FAMIGLIARI VALUES ('CCCREE1234567891','FALSE','10-03-2020','Elisabetta','Regina','3117664412','2');

INSERT INTO VOLONTARI VALUES ('LKJMNB09876541','07-01-2021','Cesare','Giulio','3981237744','quadriga','TRUE','TRUE','TRUE');
INSERT INTO VOLONTARI VALUES ('OPPMNB09876548','04-09-2021','Marco','Antonio','3331237777','apecar','TRUE','FALSE','TRUE');
INSERT INTO VOLONTARI VALUES ('GHKMNB09876545','12-12-2020','Nerone','Claudio','3781237723','porsche','TRUE','FALSE','TRUE');
INSERT INTO VOLONTARI(cfV, dataN, cognomeV, nomeV, TelV, seTrasporta, seAccoglie, seScarica)
VALUES ('AHKMNB09876542','12-12-2020','Nerone','Claudio','3721237723','FALSE','FALSE','TRUE');

INSERT INTO TURNI VALUES ('20000','11-18-2023','9:00','18:00','GHKMNB09876545');
INSERT INTO TURNI VALUES ('20003','11-18-2024','9:00','18:00','GHKMNB09876545');
INSERT INTO TURNI VALUES ('20004','11-18-2024','10:00','12:00','GHKMNB09876545');
INSERT INTO TURNI VALUES ('20001','10-11-2023','9:00','12:00','LKJMNB09876541');
INSERT INTO TURNI VALUES ('20002','12-03-2022','15:00','18:00','OPPMNB09876548');
INSERT INTO TURNI VALUES ('20005','11-18-2023','9:00','18:00','AHKMNB09876542');

INSERT INTO TRASPORTI VALUES ('30000','gls','07-06-2019','23:59','2','OPPMNB09876548'); 
INSERT INTO TRASPORTI VALUES ('30001','dhl','10-02-2021','09:00','20','LKJMNB09876541');
INSERT INTO TRASPORTI VALUES ('30002','amazon','01-02-2020','17:30','45','OPPMNB09876548');
INSERT INTO TRASPORTI VALUES ('30003','tnt','01-10-2021','18:30','100','OPPMNB09876548');

-- Si inseriscono già i saldiSucc ai fini del testing degli script SQL
INSERT INTO APPUNTAMENTI VALUES ('40000','50','20','03-16-2023','20:00','1','DDDEEE1234567890','OPPMNB09876548');
INSERT INTO APPUNTAMENTI VALUES ('40001','59','48','01-08-2023','14:00','1','AAAEEE1234567890','LKJMNB09876541');
INSERT INTO APPUNTAMENTI VALUES ('40002','40','15','09-24-2022','12:00','1','GGGEGI1234567890','GHKMNB09876545');
INSERT INTO APPUNTAMENTI VALUES ('40003','40','15','08-24-2023','12:00','2','CCCREE1234567891','LKJMNB09876541');
INSERT INTO APPUNTAMENTI VALUES ('40004','51','31','08-24-2023','9:00','2','CCCREE1234567891','GHKMNB09876545');
INSERT INTO APPUNTAMENTI(IdA, saldoPrec, saldoSucc, dataA, ora, idCliente, cfV)
VALUES ('40005','35','32','10-25-2022','10:00','4','GHKMNB09876545');
INSERT INTO APPUNTAMENTI VALUES ('40006','35','30','09-25-2022','12:00','1','GGGEGI1234567890','GHKMNB09876545');

INSERT INTO INVENTARIO VALUES (1,'mozzarella','latticini','3 se chiusa', 50, 3, 0);
INSERT INTO INVENTARIO VALUES (2,'insalata','verdure','1', 10, 1, 0);
INSERT INTO INVENTARIO VALUES (3,'birra','bevande','circa 5', 10, 5, 0);
INSERT INTO INVENTARIO VALUES (4,'vino','bevande','1000', 50, 3, 0);
INSERT INTO INVENTARIO VALUES (5,'tonno','pesce','1', 2, 1, 0);
INSERT INTO INVENTARIO VALUES (6,'torta','dolci','60 circa', 0, 5, 0);
INSERT INTO INVENTARIO VALUES (7,'mikado','dolci',NULL, 70, 1, 0);

-- PROVA SU AUTOINCREMENT di postgre
INSERT INTO DONAZIONI(importo, dataD, telD) VALUES ('200','02-10-2020',3426464513);
INSERT INTO DONAZIONI(importo, dataD, telD) VALUES ('250','12-10-2020',3456664510);
INSERT INTO DONAZIONI(importo, dataD, telD) VALUES ('215','03-09-2019',3426464513);
--
INSERT INTO DONAZIONI VALUES ('50000','500','03-20-2021',3456664510);
INSERT INTO DONAZIONI VALUES ('50001','100','11-10-2020',3426464513);
INSERT INTO DONAZIONI VALUES ('50002','275','02-08-2020',3456664510);

INSERT INTO MERCI VALUES ('60000','150','50','10-01-2019','12:00','5-01-2022','LKJMNB09876541', NULL,'30000',1);
INSERT INTO MERCI VALUES ('60001', NULL,'10','01-01-2021','10:00','10-01-2022','OPPMNB09876548','50001','30001',2);
INSERT INTO MERCI VALUES ('60002','40','8','07-26-2020','19:00','4-08-2023','GHKMNB09876545', NULL,'30002',3);
INSERT INTO MERCI VALUES ('60003','10','2','07-26-2020','19:00','4-08-2023','LKJMNB09876541', NULL,'30002',3);
INSERT INTO MERCI VALUES ('60004','150','50','05-16-2021','23:00','6-09-2023','LKJMNB09876541', NULL,'30003',4);
INSERT INTO MERCI VALUES ('60005','2','2','05-16-2021','23:00','05-02-2022','OPPMNB09876548', NULL,'30003',5);
INSERT INTO MERCI VALUES ('70000','70','70','5-02-2022','11:00',NULL,'LKJMNB09876541', NULL,'30000',7);

INSERT INTO ACQUISTI VALUES ('40000','60000','10');
INSERT INTO ACQUISTI VALUES ('40001','60001','1');
INSERT INTO ACQUISTI VALUES ('40002','60002','5');
INSERT INTO ACQUISTI VALUES ('40001','60002','2');
INSERT INTO ACQUISTI VALUES ('40003','60002','3');
INSERT INTO ACQUISTI VALUES ('40003','60003','2');
INSERT INTO ACQUISTI VALUES ('40006','70000','5');
INSERT INTO ACQUISTI VALUES ('40005','60000','1');

INSERT INTO APPARTENENZE VALUES (3,'LKJMNB09876541');
INSERT INTO APPARTENENZE VALUES (4,'OPPMNB09876548');
INSERT INTO APPARTENENZE VALUES (3,'GHKMNB09876545');